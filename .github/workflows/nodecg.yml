name: NodeCG
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  nodecg:
    runs-on: ubuntu-latest
    steps:
      - name: Create nodecg dir
        run: echo ${PWD} && mkdir nodecg && cd nodecg && echo ${PWD}
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - name: Install nodecg-cli
        run: npm install --global nodecg-cli
      - name: Setup NodeCG
        run: cd nodecg && nodecg setup
      - name: Setup NodeCG config
        run: |
          cd nodecg
          mkdir cfg
          echo '{"bundles": {"paths": ["/nodecg/nodecg-io","/nodecg/nodecg-io/services","/nodecg/nodecg-io/samples"]}}' > ./cfg/nodecg.json
      - uses: actions/checkout@v2
        with:
          path: "nodecg/nodecg-io"    
      - name: Install system dependencies
        run: sudo apt update && sudo apt-get -y install libusb-1.0-0-dev libasound2-dev libudev-dev
      - name: Install nodejs dependencies
        run: cd nodecg/nodecg-io && npm ci
      - name: Build Typescript
        run: cd nodecg/nodecg-io && npm run build
      - name: Run test
        run: cd nodecg/nodecg-io && node .scripts/ci-nodecg-integration.mjs